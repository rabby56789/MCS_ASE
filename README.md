
MCS基本資料設定
需要先新增下列基本資料至MCS資料庫內，系統才可以運作。
儲位
此為最基本的資料，需要新增修改刪除可至:
功能列表/基本資料管理/儲位 做設定

可以透過查詢功能查看儲位資訊



新增功能內，QRcode請填寫RCS上的格式，XXXXXX地圖簡碼XXXXXX。

編輯功能，請先點擊需要修改的資料，才可啟用編輯功能


刪除功能，先點選要刪除的資料行，才可點擊刪除按鈕

刪除功能會再確認是否要刪除

匯出功能，點選匯出直接將儲位以xlsx格式匯出



區域儲位
區域儲位將儲位做群組，是任務派送的重要參數
設定區域儲位可至:
功能列表/基本資料管理/區域儲位

查詢、新增、編輯、刪除、匯出功能詳細操作如同功能列表/基本資料管理/儲位，請參考:章節1.1。
點擊區域資料行，可至下一張表內查看目前區域包含儲位。



點擊區域資料行，可至下面另一個新增按鈕，新增該區域的儲位，點擊新增後會跳出查詢儲位視窗，該查詢僅查詢的到目前沒有包含再任一個區域的儲位，透過點選儲位，將儲位新增到區域內。

點擊區域資料行，再點擊下一張表內的儲位資料行，才可使用刪除按鈕解除該儲位和此區域的綁定，刪除功能並不會將該儲位刪除，只是使該儲位不再屬於該區域。



混和儲位
混和儲位被分為出發型與目的型，出發型為如果今天目的地沒位置，先把貨架搬到出發儲區附近的儲區，之後等待目的地有位置時再把貨架從該儲區搬到目的地，而目的型則是搬到目的儲區附近的儲區就結束。
一個儲區如果同時有出發型和目的型儲區的設定，會先優先觸發出發型儲區。
設定混和儲位可至:
功能列表/基本資料管理/混和儲位

點擊查詢可查詢目前各區域的混和儲位設定，欄位第二出發區和第二目的區就是代表出發型和目的型混和儲位。



先點擊資料行，才可使用編輯功能

點選編輯功能後跳出編輯視窗，再點選要修改的混和儲位類型



按查詢會列出區域資料，點選要加入的區域，按確定兩次就編輯好了。



刪除功能，一樣點擊資料行後啟用，該刪除為刪除混和儲位設定，出發型和目的型的設定皆會被刪除。





貨架
設定貨架可至:
功能列表/基本資料管理/貨架

查詢、新增、編輯、刪除、匯出功能詳細操作如同功能列表/基本資料管理/儲位，請參考:章節1.1。



IOT設定
設定IOT可至:
功能列表/基本資料管理/IOT設定

點擊查詢可依照條件搜尋到已加入MCS的IOT設備。



先點擊新增會跳出新增視窗，再按下查找SN\_KEY。

點擊查詢後，這邊的資料來自OT端設備API，找到要新增的設備後點選資料行按下確定，如果找不到要新增的設備資訊，請先確定OT端有該設備。



點選後會自動帶入設備資訊，通常不需要再做其他修改，按下確定即可，若有需要還是可以修改內容。

編輯和刪除功能詳細操作如同功能列表/基本資料管理/儲位，請參考:章節1.1。


命令管理
關於設備命令都在這裡設置。
MQTT
設定控制設備MQTT命令(包含梯控)可至:
功能列表/命令管理/MQTT

依照條件按下查詢，可查看命令內容。



點擊新增跳出新增視窗，先按下查找IOT設備。

查詢要新增命令的IOT設備，點選資料行後按下確定。



選擇完設備後，設備snkey和IP會自動帶入，輸入必要欄位，命令ID該欄位不可重複，推薦使用IOT設備編號加上命令動作來填寫該欄位，如下圖範例IOT036\_red，命令名稱可識別即可，DO/DI選擇如果命令是用來控制設備的請選擇DO，用來查看設備狀態則用DI，命令內容填寫如下圖，按下確認後即新增。

編輯功能點選要編輯的資料行後啟用，只有命令名稱、DI/DO和命令內容可提供修改，要注意的是因舊版MCS介面尚未開發完全時，所新增的命令皆為手動新增到資料庫，DO/DI設備類別的部分尚未設定，在確定編輯時請依照原本命令的類型小心選擇。

刪除功能詳細操作如同功能列表/基本資料管理/儲位，請參考:章節1.1。
電梯命令
設定電梯命令可至:
功能列表/命令管理/電梯命令

電梯命令有3大類，開門、關門、偵測樓層，假如今天要新增新的電梯樓層，請先準備好這三種電梯的MQTT命令，新增MQTT命令請至章節2.1新增。
電梯命令這邊使用相同「代號」將MQTT命令組合成一個電梯流程，提供給電梯模組使用，每一次有新的電梯樓層要新增時上述3大類型皆要新增，否則電梯流程會不完整。

新增開門流程
以6號電梯8樓A側為參考，開門新增的電梯流程要有6筆資料，如下圖



點擊新增跳出新增視窗開始新增，選擇電梯後，新增開門流程「代號」請依照【floor樓層Open】格式填寫，例如:floor10AOpen，點擊命令右側查詢要編入的命令，順序和下個順序欄位請依照範例填寫，順序欄位代表MCS電梯模組執行命令的順序，下個順序如果為0代表開門流程結束，類型請填0。

依照範例順序，新增6筆代碼相同，但編入命令不同的電梯命令，以下為編排的MQTT命令參考內容，以下命令請先在章節2.1MQTT確認是否加入，命令ID內容為新增MQTT時所設定。



新增關門流程
以6號電梯8樓A側為參考，關門新增的電梯流程要有2筆資料，如下圖

新增關門流程「代號」請依照【floor樓層Close】格式填寫，例如:floor10AClose，點擊命令右側查詢要編入的命令，順序和下個順序欄位請依照範例填寫，順序欄位代表MCS電梯模組執行命令的順序，下個順序如果為0代表開門流程結束，類型請填0。

依照範例順序，新增2筆代碼相同，但編入命令不同的電梯命令，以下為編排的MQTT命令參考內容，以下命令請先在章節2.1MQTT確認是否加入。



新增偵測樓層
以6號電梯為參考，如果有新增樓層，為了讓電梯任務完整，請新增一筆代號為【floorGet】，編入命令為查看電梯狀態為新增樓層的MQTT，並且需要去調整其他樓層的下個順序欄位。
以要新增6號電梯12樓為例，請先查詢目前6號電梯的floorGet。

搜尋內容如下。

該順序欄位代表MCS電梯模組在偵測電梯樓層時的順序，因為要加入新的樓層偵測，要先把下個順序為0的電梯偵測編輯為其他值，在將要新增的偵測樓層加入，並且下個順序為0，順序依照目前範例填上14，類型為1。

加入完成後查詢目前6號電梯的floorGet，如下。

3種都新增完後建議利用任務【6號電梯測試\_M01F-BEW\_M01F-BE】或是【1號電梯測試\_M01F-BEW\_M01F-BE】，參考章節3.2之(3)，去修改目的樓層為新建的電梯樓層命令做測試。


MCS 任務建立
要新增一個任務前，要先有相對應的RCS任務模板，以及新任務所用到的設備相關子任務都先準備好，再由MCS配合RCS模板去編排任務。
建立任務流程圖



準備工作
配合RCS模板設定和任務所要控制的設備去準備相關的子任務。

準備子任務
功能列表/任務管理/子任務設定

常需要用的子任務有這4種類型，以下各講解如何新增:
RCS API：用來建立RCS模板，發送要建立的模板資訊給RCS。
點擊新增按鈕後，子任務類型選擇RCS API，api類型選擇genAgvSchedulingTask\_new，命令欄位會自動帶入，子任務編號和名稱皆為必填，RCS任務模板請填寫要新增的模板名稱。



agvCallback：等待RCS回傳callback子任務。
點擊新增按鈕後，子任務類型選擇agvCallback，api類型選擇agvCallback，method欄位請填寫RCS回傳的callback method例如，autodoor\_in，子任務編號和名稱皆為必填。

MQTT Publish：發送MQTT。
點擊新增按鈕後，子任務類型選擇MQTT Publish，SN\_KEY點擊查詢選擇設備，再點擊命令查詢，會自動搜尋該設備可用的MQTT命令，若查無可用命令請檢查命令管理內是否有新增，子任務編號和名稱皆為必填。



MQTT Subscribe： 檢查設備狀態。
新增方式與MQTT Publish相同，只是再選擇子任務類型和命令的時候，子任務類行為MQTT Subscribe，命令類行為DO。


配合RCS模板子任務
依照RCS模板設定站點集合、agvCallback和是否需要觸發，去準備這些相應的子任務。
站點集合
建立RCS任務XXX 子任務，在編輯任務時內容需要填寫RCS模板內的站點集合，模板內有幾個就填幾個，ASE\_START\_QRCODE表示起點，ASE\_TARGET\_QRCODE表示終點，這些字串之後會被程式替換為正確的點位，固定的點位則代表進電梯等待點或是其他設備的等待點位，他們之間用「,」逗號區隔。

以後段物料運送\_M01F-BE\_M11F-BE為例，在任務流程編輯時該子任務需要加入站點集合資訊。



agvCallback
對應RCS模板的第三方應用為agvCallback，模板有幾個就增加幾個agvCallback子任務，agvCallback子任務有例如，等待任務結束、等待到達風淋門入口…等，callback會配合站點集合，如下圖的模板，此agvCallback的method為elevator\_in，就是當小車走到某個點(站點)後，RCS會發callback給MCS，MCS子任務等待到達電梯入口會等待RCS回傳elevator\_in，接收到後任務才繼續執行。




是否需要觸發(Continue Task)
後續任務依流程去安排，子任務繼續任務則看RCS模板是否需要觸發，有的話則需要增加該流程，通常繼續任務會下在等待agvcallback之後，假如RCS模板上，需要觸發是在等待callback method 【task\_finish】，則表示任務是在收到【task\_finish】的前一個callback之後才下Continue Task。




電梯相關子任務
與電梯相關流程任務可參考: 
6號電梯測試\_M01F-BEW\_M01F-BE(6號電梯用)
1號電梯測試\_M01F-BEW\_M01F-BE(1號電梯用)
在電梯流程內可插入其他子任務，子任務流程【建立X號電梯任務】需填寫要往上還是往下，以及起始、目標樓層。
範例如下圖:



6號電梯有A側和B側，起始和目的樓層後面直接帶入A或B就好了



Booking子任務
因為有多個任務執行，有時候像是自動門、風淋門、升降梯等，同一時間只能給一台AGV通行，在有多筆任務執行時需要去控管，就需要使用到Booking機制，Booking是誰先預約到資源誰先使用，使用完後要歸還也就是Unbooking該資源。
目前可使用的預約(Booking)子任務

目前可使用的歸還(Unbooking)子任務

在任務編輯流程內加入此子任務時，需要在站點集合內填寫要預約或要歸還的資源名稱，此資源名稱為自定義，在編輯任務時，預約的資源名稱要和歸還的資源名稱一樣。


目前使用資源定義名稱如下:
B2\_airshower：MB2F風淋門
01F\_EandA：M01F升降梯和B側自動門
CPD11FLOCK：M11F-MD自動門鎖
11F\_Autodoor：M11F-MD自動門
08F\_Autodoor：M08F-MD自動門
No1Elv：M01F電梯1號
01F\_AirShower2：M01F B側風淋門


鎖定子任務
用於退庫任務，任務結束後儲位需要鎖定，可用鎖定子任務。

在任務編輯流程內加入此子任務時，需要在站點集合內填寫兩個值用「,」隔開，以下圖為例【1,ASE\_TARGET\_QRCODE】
第一個值可填寫0:解鎖，1:上鎖，第二個值填寫要上鎖/解鎖的儲位。




開始設定任務
新增任務設定
功能列表/任務管理/任務設定
新增任務的任務名稱格式必須為Jobname\_起始區\_目的區
例如:退空車\_M11F-BE\_M01F-BEW。


建立完任務後，該任務裡必須要有多個子任務也就是任務流程，否則任務內容為空的不會執行。


對任務新增流程
功能列表/任務管理/任務流程編輯
查詢前面剛新增的任務，任務流程會看到為No Data，我們必須替這任務新增流程，一個任務由多個子任務組成，配合RCS模板和任務需求，點選新增按鈕將前面準備的子任務加入並做排序。




新增介面先查詢我們要加的子任務，填入順序，再依照子任務類型看是否需要填寫站點集合。



複製任務功能
功能列表/任務管理/任務設定
當要想要建立的任務和現有任務流程差不多，只是起始區和目的區不一樣的情況下可使用，該功能會複製現有任務的流程，但流程的詳細參數，例如站點集合、設備相關子任務等，則需要手動再去更改。



MCS 查看狀態
任務狀態
佇列
功能列表/任務管理/佇列
提供查看目前任務是否已建立成功，或是有無觸發混和儲位，此頁面開啟預設先搜尋狀態為未建立任務。

查詢功能，可依照要搜尋的條件查找任務，混和儲位下拉選單可篩選任務是否為混和儲位觸發所產生，狀態則有4種未建立、已建立、不可執行和取消。



表格內可查看的任務資訊有以下，
任務名稱:上位派A01指定的job\_name
貨架編號:上位派A01指定的car\_no
起始位置: 上位派A01指定的start\_loc
起始區域: 上位派A01指定的start\_area
第二起點區: 觸發混和儲位出發型，所要搬到的儲區
目的位置: 上位派A01指定的start\_loc
目的區域: 上位派A01指定的start\_area
第二目的區: 觸發混和儲位目的型，所要搬到的儲區
混和儲位:顯示此任務是否為混和儲位觸發任務
狀態:該任務建立狀態
message:任務建立成功則顯示成功，失敗則顯示失敗原因，若該任務觸發混和儲位會顯示TypeStart(出發型)和TypeTarget(目的型)
嘗試次數:嘗試建立任務的次數
建立任務時間:上位用A01下派任務的時間



出發型混和儲位會將原本的任務分化成2個任務，一個是【暫存】，此任務為平面搬運，將貨架搬至混和儲位，另一個任務為原本的任務，但是出發位置更變為混和儲區的儲位，在佇列資料表內可查看。

目的型則會分出一筆目的地是到混和儲區的任務。

取消排隊功能需先點選要取消的任務，且該任務狀態為未建立才可啟用。



在線任務管理
功能選單\任務管理\在線任務管理
查看任務執行進度、完成狀態，可查詢歷史任務紀錄。

查詢功能可依照要搜尋的條件查詢，狀態有5種如下圖，也可用建立時間查找任務紀錄。




表格內可查看以下資訊，
任務單號:上位下A01的seq序號，前面有M\_代表為MCS下A01的seq序號
RCS任務單號:由RCS回傳過來此任務在RCS內的單號
任務類型:此任務使用的RCS模板名稱
AGV編號:執行此任務的小車
貨架編號:執行此任務的貨架
起點位置、目標位置:任務的起點和終點
任務名稱:所執行的任務
任務執行區段:目前此任務的執行進度
狀態:顯示任務目前狀態
建立任務時間、任務完成時間:若任務尚未結束，完成時間為目前時間
訊息:顯示RCS回傳的錯誤訊息，例如: 未知的呼叫站点: 098500ME097827 

取消任務功能需先點選要取消的任務，且該任務狀態為建立任務或是執行中才可啟用，若取消任務剛好是已經叫電梯或是在電梯內取消的，AGV復原後要記得重啟JOB。



儲位狀態
該功能提供查看目前儲位的狀態，以及提供解鎖儲位功能。
功能選單\任務管理\儲位管理

查詢條件提供儲位名稱、區域名稱和鎖定狀態做查詢，預設搜尋鎖定狀態為已鎖定。

點選已鎖定資料可開啟解鎖功能，將儲位解鎖。

載具(貨架)狀態
功能選單\任務管理\載具管理

顯示每一個貨架目前所在的位置，若該貨架目前有任務搬運中或是此貨架不存在，位置資料顯示則會為空白，可以透過顯示貨架資訊查詢該貨架位置或是刷新每一個貨架的資訊。



設備狀態
功能選單\任務管理\設備管理
該功能為透過OT端API，將設備資訊匯入至MCS資料庫。

查詢功能可篩選的條件有樓層和I/O模組名稱，從MQTT匯入按鈕為再調用一次OT端API，重寫OT資料至MCS資料庫。

資料表內可展開，查詢該設備的每一個PIN的資訊。

看板
登入後於首頁/前台，可查看任務看板、AGV狀態和設備狀態。

任務看板
左上方有按鈕提供任務狀態篩選，全部、運送中、已送達、暫存，運送中燈號為綠色，已送達為黃色，運送中任務執行時間超過15分鐘為紅色，若取消任務則為灰色。



AGV狀態
小車有異常且也有執行任務，會顯示該小車執行任務的起始儲位、目的儲位、任務單號和任務名稱，狀態為RCS回傳小車狀態。

設備狀態
顯示目前設備狀態，DI查看設備狀態，MQTT回傳時間等於設備狀態更新的時間。



MCS Log 查詢
上位系統訊息
功能選單\系統日誌\上位系統訊息\日月光
此功能可檢視每一筆下API的紀錄，包含A01、A02、A03、A04、A05的紀錄。

透過查詢功能可篩選出需要瀏覽的紀錄，狀態下拉選單可查詢該命令狀態為成功還是失敗，資料欄位顯示的資訊以A01為主，其他API沒有該欄位資訊則為空，資料欄【訊息】如果命令失敗則會顯示原因於此欄位。


下位系統訊息
MQTT
功能選單\系統日誌\下位系統訊息\MQTT
此功能可查看每一個任務下的MQTT訊號。

查詢功能提供主任務單號、貨架編號和任務建立日期可篩選，點擊資料行左側按鈕來查看下MQTT紀錄。



RCS
功能選單\系統日誌\下位系統訊息\RCS
此功能紀錄MCS發送給RCS的紀錄。

查詢功能可做篩選查詢，記錄內顯示資料欄位【訊息】，若發送失敗則會顯示RCS回傳的錯誤訊息，例如: 未知的呼叫站点: 098500ME097827。



平板
該功能提供MCS頁面派發任務，以及簡單的任務清單和歷史任務瀏覽。

任務清單
從功能導覽頁面，點擊任務清單按鈕，可查看頁面，會看到兩張表格，一個是執行中，另一個是待執行。
執行中內容相當於章節4.1任務狀態之(2)在線任務管理的內容。



待執行相當於內容相當於章節4.1任務狀態之(1)佇列的內容。

歷史任務
從功能導覽頁面，點擊歷史任務按鈕，可查看頁面，該頁面內容記錄歷史任務，可透過上方篩選欄位查找歷史任務紀錄。



建立任務
從功能導覽頁面，點擊建立任務按鈕，可透過MCS建立任務，首先選擇目的地，再輸入要派送的任務、貨架和優先權，確認輸入內容按下建立。

MCS會傳送請求給API，API確認任務可建立後則會提示成功，若無法建立會提示錯誤原因。



呼叫台車
從功能導覽頁面，點擊呼叫台車按鈕，可透過MCS建立呼叫空車任務，此頁面專用於建立呼叫空車任務，選擇開始位置與目的地以及優先度，會建立由開始區到目的地區的呼叫空車任務。

MCS會傳送請求給API，API確認任務可建立後則會提示成功，若無法建立會提示錯誤原因。



帳號權限管理
員工基本資料(部門、職稱、員工)
在新增一個帳號之前，要先有員工的基本資料。
部門
部門資料新增修改刪除可至:
功能列表/帳號權限管理/部門 做設定

可以透過查詢功能查看部門資訊。

查詢、新增、編輯、刪除、匯出功能詳細操作如同功能列表/基本資料管理/儲位，請參考:章節1.1。


職稱
職稱資料新增修改刪除可至:
功能列表/帳號權限管理/職稱 做設定

可以透過查詢功能查看職稱資訊。

查詢、新增、編輯、刪除、匯出功能詳細操作如同功能列表/基本資料管理/儲位，請參考:章節1.1。


員工
員工資料新增修改刪除可至:
功能列表/帳號權限管理/員工 做設定

可以透過查詢功能查看員工資訊。

點擊新增，跳出新增視窗，新增員工需要關聯該員工的部門和職稱，點選搜尋按鈕去選擇，輸入員工編號和員工姓名此兩欄為必填，其餘資訊欄位為可選擇新增，填選完後點及確認及新增完畢。

編輯、刪除功能詳細操作如功能列表/基本資料管理/儲位，請參考:章節1.1。
帳號權限資料
有員工資料後，才可開始新增帳號和權限資料。
系統使用者
功能列表/帳號權限管理/系統使用者 做設定

可透過查詢功能，查看目前系統使用者資訊。



點選新增按鈕，跳出新增視窗開始新增，點選搜尋員工編號關聯員工資料，輸入帳號密碼，點選確定新增結束。

編輯、刪除、匯出功能詳細操作如功能列表/基本資料管理/儲位，請參考:章節1.1。
注意!若從系統使用者介面刪除使用者，權限群組-使用者介面，包含該使用者的群組將會移除該使用者。

權限群組-使用者
此功能為將系統使用者用不同的群組做分類。
功能列表/帳號權限管理/權限群組-使用者 做設定



可透過查詢功能，查看目前權限群組資訊，以及該群組的使用者。

點選群組資料，可查看該群組有哪些使用者。

點選新增按鈕，跳出新增視窗可新增新的權限群組，編輯、刪除功能詳細操作如功能列表/基本資料管理/儲位，請參考:章節1.1。

在顯示權限群組使用者的資料表上方的新增按鈕，則是可將其他使用者新增到目前搜尋的群組內。

如下圖，新增完畢後權限群組ADMIN增加了一個名稱為RubyLu的系統使用者。



在顯示權限群組使用者的資料表上方的刪除按鈕，則是可把該使用者從群組中移除。

刪除成功。

權限群組-功能
此功能將每個群組可使用的功能做分類。
功能列表/帳號權限管理/權限群組-功能 做設定



可透過查詢功能，點選群組資料查看目前所選權限群組可使用那些功能。

在顯示功能資料表上方的新增按鈕，則是可以從該群組新增其他功能，點選新增按鈕跳出新增視窗。



新增成功後，會看到左側功能列表內多出此功能。

刪除按鈕為將該功能從群組中移除，點選要移除的功能後，按下刪除。


刪除成功。

常見問題
A01回傳錯誤訊息
【非呼叫空車任務，請先指定貨架和start\_loc填寫後再派】
除了呼叫空車任務，其他的任務上位在派送時皆需要指定派送任務的貨架和儲位位置。
【貨架trolleyId在Queue中已有任務\貨架trolleyId已有任務正在執行】
A01會先檢查現在貨架在佇列和在線任務管理內建立時間10分鐘內是否有任務，有任務就會回傳此訊息。
【查無此任務，請先至【任務設定】設置 ，JOB\_NAME: ……】
A01透過上位所輸入的參數，計算要執行的任務名稱，出現此訊息有可能為上位輸入參數有誤，或是查無符合的任務名稱，需要去任務設定配置。
佇列內message
【貨架號碼查無起點位置或已有任務】
出現此訊息是因為MCS找不到目前貨架位置，有可能是貨架正被小車搬運中，或者是此貨架在RCS內沒有帳存在。
【貨架所在位置與start\_loc不相符】
通常出現此訊息為當上位連續下兩筆以上相同的任務，貨架在第一筆任務已建立，並執行完成後，貨架位置以不同，第二筆在佇列中的任務要建立時計算出目前貨架位置和要建立的任務起始位置不相符，直接取消第二筆佇列任務就好了。
【出發儲位start\_loc已被鎖定】
出發儲位為被鎖定的狀態，要任務順利建立至儲位管理找到該儲位點選解鎖即可。
【出發儲位 {start} 不屬於出發儲區 {startArea}】
出現此訊息，可至功能列表\基本資料管理\區域儲位，查看出發儲區是否包含該出發儲位。
【查無空儲位】
因目前任務的目的儲區已無空儲位。
故障重啟方式
至伺服器管理員(IIS)，找到站台MCS，按下重新啟動進行重啟。

